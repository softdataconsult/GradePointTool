---
title: "Grade Point Tool for multiple courses"
format: html
editor: visual
---

```{r}
# ============================
# GradePointTool — Many courses script
# ============================
# install.packages(c("readxl","openxlsx","dplyr","janitor","readr","ggplot2","tidyr"))  # once

library(readxl)
library(openxlsx)
library(dplyr)
library(janitor)
library(readr)
library(ggplot2)
library(tidyr)
library(tools)

# ----------------------------
# Helpers
# ----------------------------
grade_point <- function(score) {
  brks   <- c(-Inf, 19, 29, 39, 44, 49, 54, 59, 64, 69, 74, 100)
  points <- c(0.00, 1.00, 1.50, 2.00, 2.25, 2.50, 2.75, 3.00, 3.50, 3.75, 4.00)
  as.numeric(points[cut(score, breaks = brks, labels = FALSE, right = TRUE)])
}
letter_grade <- function(score) {
  brks   <- c(-Inf, 19, 29, 39, 44, 49, 54, 59, 64, 69, 74, 100)
  grades <- c("F","F","F","E","D","C","C+","B","B+","A","A+")
  as.character(grades[cut(score, breaks = brks, labels = FALSE, right = TRUE)])
}
grade_broad <- function(grade_fine) {
  dplyr::case_when(
    grade_fine %in% c("A+","A") ~ "A",
    grade_fine %in% c("B+","B") ~ "B",
    grade_fine %in% c("C+","C") ~ "C",
    grade_fine == "D" ~ "D",
    grade_fine == "E" ~ "E",
    TRUE ~ "F"
  )
}
to_num <- function(x) suppressWarnings(readr::parse_number(as.character(x)))

# Excel-safe, case-insensitive unique names
fix_names_excel <- function(df) {
  nm <- names(df)
  nm[is.na(nm) | trimws(nm) == ""] <- "unnamed"
  key <- tolower(nm)
  if (any(duplicated(key))) {
    idx <- ave(seq_along(key), key, FUN = seq_along)
    nm  <- ifelse(idx == 1, nm, paste0(nm, "_", idx))
  }
  nm <- make.unique(nm, sep = "_")
  names(df) <- nm
  df
}
# Drop raw columns that standardized ones replace (avoid header clashes)
dedupe_source_cols <- function(df, name_col, matric_col, total_col, prac_col, ca_col, exam_col) {
  drop_cols <- c(name_col, matric_col, total_col, prac_col, ca_col, exam_col)
  dplyr::select(df, -dplyr::any_of(drop_cols))
}
# Pretty colours
plot_grade_bars <- function(data, fine = TRUE) {
  if (fine) {
    data <- data %>% mutate(GradeFine = factor(Grade, levels = c("A+","A","B+","B","C+","C","D","E","F")))
    ggplot(data, aes(x = GradeFine, fill = GradeFine)) +
      geom_bar() +
      scale_fill_viridis_d(option = "D", direction = -1) +
      labs(x = "Grade (fine)", y = "Count", title = "Distribution of Grades (Fine)") +
      theme_minimal(base_size = 12) + theme(legend.position = "none")
  } else {
    data <- data %>% mutate(GradeAF = factor(grade_broad(Grade), levels = c("A","B","C","D","E","F")))
    ggplot(data, aes(x = GradeAF, fill = GradeAF)) +
      geom_bar() +
      scale_fill_viridis_d(option = "D", direction = -1) +
      labs(x = "Grade (A–F)", y = "Count", title = "Distribution of Grades (A–F)") +
      theme_minimal(base_size = 12) + theme(legend.position = "none")
  }
}
plot_score_histogram <- function(data, binwidth = 5) {
  ggplot(data, aes(x = Total_100, fill = after_stat(count))) +
    geom_histogram(binwidth = binwidth, boundary = 0, closed = "left", colour = "white") +
    scale_fill_viridis_c(option = "C") +
    labs(x = "Total score (0–100)", y = "Count", title = "Histogram of Total Scores") +
    scale_x_continuous(breaks = seq(0, 100, by = 10), limits = c(0, 100)) +
    theme_minimal(base_size = 12) + theme(legend.position = "none")
}

# ----------------------------
# Core processor (single file)
# ----------------------------
process_exam_sheet <- function(in_path,
                               out_path,
                               sheet = 1,
                               clamp_0_100 = TRUE,
                               save_plots = TRUE,
                               plot_prefix = sub("(\\.[^.]+)$", "", out_path),
                               write_excel_tables = TRUE) {
  raw <- readxl::read_excel(in_path, sheet = sheet)
  df  <- raw %>% clean_names()

  # Detect columns
  name_col   <- intersect(names(df), c("name","student_name"))[1]
  matric_col <- intersect(names(df), c("matric_no","reg_no","matric"))[1]
  prac_col   <- intersect(names(df), c("prac_50","practical_50","prac"))[1]
  ca_col     <- intersect(names(df), c("ca_10","continuous_assessment_10","ca"))[1]
  exam_col   <- intersect(names(df), c("exam_40","exam"))[1]
  total_col  <- intersect(names(df), c("total_100","total"))[1]

  # Build / coerce Total_100
  if (is.na(total_col) && all(!is.na(c(prac_col, ca_col, exam_col)))) {
    df <- df %>% mutate(
      .prac = to_num(.data[[prac_col]]),
      .ca   = to_num(.data[[ca_col]]),
      .exam = to_num(.data[[exam_col]]),
      Total_100 = .prac + .ca + .exam
    )
  } else if (!is.na(total_col)) {
    df <- df %>% mutate(Total_100 = to_num(.data[[total_col]]))
  } else {
    stop("Could not find TOTAL (100) or the PRAC/CA/EXAM columns.")
  }
  if (clamp_0_100) df <- df %>% mutate(Total_100 = pmax(0, pmin(100, Total_100)))

  # Enriched output (GradePoint with 2 decimals)
  out <- df %>%
    mutate(
      Name       = if (!is.na(name_col)) .data[[name_col]] else "",
      Matric_No  = if (!is.na(matric_col)) .data[[matric_col]] else NA_character_,
      GradePoint = round(grade_point(Total_100), 2),
      Grade      = letter_grade(Total_100)
    ) %>%
    relocate(Name, Matric_No, Total_100, GradePoint, Grade) %>%
    dedupe_source_cols(name_col, matric_col, total_col, prac_col, ca_col, exam_col) %>%
    fix_names_excel()

  # Summaries with Percent (0–100)
  grade_fine_lv  <- c("A+","A","B+","B","C+","C","D","E","F")
  grade_broad_lv <- c("A","B","C","D","E","F")
  n_all <- nrow(out)

  summary_fine <- out %>%
    mutate(Grade = factor(Grade, levels = grade_fine_lv)) %>%
    count(Grade, name = "Count") %>%
    complete(Grade = factor(grade_fine_lv, levels = grade_fine_lv), fill = list(Count = 0)) %>%
    mutate(Percent = round(100 * Count / n_all, 1)) %>%
    fix_names_excel()

  summary_broad <- out %>%
    mutate(GradeAF = factor(grade_broad(Grade), levels = grade_broad_lv)) %>%
    count(GradeAF, name = "Count") %>%
    complete(GradeAF = factor(grade_broad_lv, levels = grade_broad_lv), fill = list(Count = 0)) %>%
    mutate(Percent = round(100 * Count / n_all, 1)) %>%
    fix_names_excel()

  # Plots
  p_bar_fine  <- plot_grade_bars(out, fine = TRUE)
  p_bar_broad <- plot_grade_bars(out, fine = FALSE)
  p_hist      <- plot_score_histogram(out, binwidth = 5)

  if (save_plots) {
    ggsave(paste0(plot_prefix, "_bar_fine.png"),  p_bar_fine,  width = 7, height = 4, dpi = 150)
    ggsave(paste0(plot_prefix, "_bar_broad.png"), p_bar_broad, width = 7, height = 4, dpi = 150)
    ggsave(paste0(plot_prefix, "_hist.png"),      p_hist,      width = 7, height = 4, dpi = 150)
  }

  # Excel workbook with tables + styles
  if (write_excel_tables) {
    wb <- createWorkbook()
    addWorksheet(wb, "Grades")
    addWorksheet(wb, "Summary_Fine")
    addWorksheet(wb, "Summary_AtoF")
    addWorksheet(wb, "Plots")

    writeDataTable(wb, "Grades", out, tableStyle = "TableStyleMedium9")
    setColWidths(wb, "Grades", cols = 1:ncol(out), widths = "auto")

    # 2-decimal format for GradePoint
    gp_col <- which(names(out) == "GradePoint")
    if (length(gp_col)) {
      twoDec <- createStyle(numFmt = "0.00")
      addStyle(wb, "Grades", twoDec,
               rows = 2:(nrow(out) + 1), cols = gp_col,
               gridExpand = TRUE, stack = TRUE)
    }

    # Percent columns -> 0–1 for Excel percent display
    sf_xl <- summary_fine  %>% mutate(Percent = Percent / 100)
    sb_xl <- summary_broad %>% mutate(Percent = Percent / 100)
    writeDataTable(wb, "Summary_Fine", sf_xl, tableStyle = "TableStyleMedium2")
    setColWidths(wb, "Summary_Fine", cols = 1:ncol(sf_xl), widths = "auto")
    writeDataTable(wb, "Summary_AtoF", sb_xl, tableStyle = "TableStyleMedium7")
    setColWidths(wb, "Summary_AtoF", cols = 1:ncol(sb_xl), widths = "auto")

    pctStyle <- createStyle(numFmt = "0.0%")
    sf_pct_col <- which(names(sf_xl) == "Percent")
    if (length(sf_pct_col)) addStyle(wb, "Summary_Fine", pctStyle,
                                     rows = 2:(nrow(sf_xl) + 1), cols = sf_pct_col,
                                     gridExpand = TRUE, stack = TRUE)
    sb_pct_col <- which(names(sb_xl) == "Percent")
    if (length(sb_pct_col)) addStyle(wb, "Summary_AtoF", pctStyle,
                                     rows = 2:(nrow(sb_xl) + 1), cols = sb_pct_col,
                                     gridExpand = TRUE, stack = TRUE)

    # Insert plots
    if (save_plots) {
      insertImage(wb, "Plots", paste0(plot_prefix, "_bar_fine.png"),
                  startRow = 1,  startCol = 1, width = 7, height = 4, units = "in")
      insertImage(wb, "Plots", paste0(plot_prefix, "_bar_broad.png"),
                  startRow = 22, startCol = 1, width = 7, height = 4, units = "in")
      insertImage(wb, "Plots", paste0(plot_prefix, "_hist.png"),
                  startRow = 43, startCol = 1, width = 7, height = 4, units = "in")
    }

    saveWorkbook(wb, out_path, overwrite = TRUE)
  }

  list(
    data           = out,
    summary_fine   = summary_fine,
    summary_broad  = summary_broad,
    plot_bar_fine  = p_bar_fine,
    plot_bar_broad = p_bar_broad,
    plot_hist      = p_hist
  )
}

# ----------------------------
# Run for many courses
# ----------------------------
dir.create("results", showWarnings = FALSE)

courses <- c("STA357_scores.xlsx", "MTH432_scores.xlsx", "GNS219_scores.xlsx")
for (f in courses) {
  course  <- file_path_sans_ext(basename(f))
  out_dir <- file.path("results", course)
  dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

  in_path  <- file.path("data", f)                     # adjust if your files are elsewhere
  out_path <- file.path(out_dir, paste0(course, "_with_grades.xlsx"))
  plot_prefix <- file.path(out_dir, course)

  message("Processing: ", course)
  res <- process_exam_sheet(
    in_path            = in_path,
    out_path           = out_path,
    sheet              = 1,
    save_plots         = TRUE,
    plot_prefix        = plot_prefix,
    write_excel_tables = TRUE
  )

  # Optional: quick console summary
  print(res$summary_broad)
}

```

